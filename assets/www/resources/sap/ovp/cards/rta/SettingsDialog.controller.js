sap.ui.define(['sap/ui/core/mvc/Controller','sap/ui/model/json/JSONModel','/sap/ui/fl/descriptorRelated/api/DescriptorChangeFactory','/sap/ui/fl/descriptorRelated/api/DescriptorInlineChangeFactory','sap/ovp/cards/CommonUtils','sap/ovp/cards/SettingsUtils','sap/m/Button','sap/m/Dialog','sap/m/Text','sap/ui/comp/valuehelpdialog/ValueHelpDialog','sap/ovp/cards/rta/SettingsDialogConstants','sap/m/MessageBox','sap/ui/model/Filter','sap/ui/model/FilterOperator'],function(C,J,D,a,c,s,B,b,T,V,S,M,F,d){'use strict';return C.extend('sap.ovp.cards.rta.SettingsDialog',{_oCardManifestSettings:{},_aRefreshNotRequired:S._aRefreshNotRequired,_aRefreshRequired:S._aRefreshRequired,onInit:function(){s.oSaveButton.attachPress(this.createAndSubmitChange,this);s.oResetButton.attachPress(this.onResetButton,this);s.oMessagePopOverButton.attachPress(this.handleMessagePopoverPress,this);},onAfterRendering:function(){s.dialogBox.addStyleClass("sapOvpSettingsDialogBox");this.setEnablePropertyForResetAndSaveButton(false);this._oCardManifestSettings=this.getView().getModel().getData();this._oOriginalCardManifestSettings=jQuery.extend(true,{},this._oCardManifestSettings);var v=this.getView(),o=v.getModel("visibility"),e=v.byId("dialogCard");if(!e.getVisible()){e=v.byId("dialogCardNoPreview");}e.getDomRef().style.minHeight=this._oCardManifestSettings.dialogBoxHeight+'px';v.byId("SettingsDialogScrollContainerForForm").getDomRef().style.height=(o.getProperty("/viewSwitchEnabled"))?this.getValueInRemString(s.iContentHeightForDialogWithViewSwitch):this.getValueInRemString(s.iContentHeightForDialog);v.byId("dialogCardOverlay").getDomRef().style.minHeight=this._oCardManifestSettings.dialogBoxHeight+'px';var f=v.byId("sapOvpSettingsForm");if(f){f.getDomRef().style.width="calc(100% - "+(this._oCardManifestSettings.dialogBoxWidth+1)+"rem)";}setTimeout(function(){var e=this.getView().byId("dialogCard");if(e.getVisible()){e.setBusy(false);}}.bind(this),2000);},validateInputField:function(e){var m,f,g,h;var o=e.getSource();if(!o.getValue()){s.oSaveButton.setEnabled(true);m=s.oMessagePopOver.getModel();f=m.getProperty("/Messages");g=m.getProperty("/Counter/All");h=m.getProperty("/Counter/Error");var t=(o.getId().indexOf("sapOvpSettingsViewName")!==-1)?"This is a mandatory field. Please enter a View Name.":sap.ui.getCore().getLibraryResourceBundle("sap.ovp").getText('OVP_KEYUSER_INPUT_ERROR');f.push({'type':"Error",'title':t,'fieldName':o.getId(),'counter':h+1});m.setProperty("/Messages",f);m.setProperty("/Counter/All",g+1);m.setProperty("/Counter/Error",h+1);m.refresh(true);}else{s.oSaveButton.setEnabled(true);m=s.oMessagePopOver.getModel();f=m.getProperty("/Messages");g=m.getProperty("/Counter/All");h=m.getProperty("/Counter/Error");for(var i=0;i<f.length;i++){if(f[i].fieldName===o.getId()){f.splice(i,1);g--;h--;i--;}}m.setProperty("/Messages",f);m.setProperty("/Counter/All",g);m.setProperty("/Counter/Error",h);m.refresh(true);this.updateCard(e);}},addView:function(e){this.setEnablePropertyForResetAndSaveButton(true);var f,o=this._oCardManifestSettings;if(o.dataPointAnnotationPath&&o.dataPoint&&o.dataPoint.length){f=o.dataPoint[0].value;}if(o.tabs&&o.tabs.length){o.newViewCounter++;o.tabs.push({annotationPath:o.lineItem[0].value,dataPointAnnotationPath:f,value:'View '+o.newViewCounter});var g=o.tabs.length;o.aViews.push({text:'View '+o.newViewCounter,key:g,isLaterAddedView:true,isViewResetEnabled:false});this.selectViewSwitch(e,g);}else{o.tabs=[{}];S.tabFields.forEach(function(t){o.tabs[0][t]=o[t];}.bind(this));o.tabs[0].value="View 1";if(o.template==="sap.ovp.cards.charts.analytical"){o.tabs.push({chartAnnotationPath:o.chart[0].value,dataPointAnnotationPath:f,value:'View 2'});}else{o.tabs.push({annotationPath:o.lineItem[0].value,dataPointAnnotationPath:f,value:'View 2'});}o.selectedKey=1;o.defaultViewSelected=1;o.aViews=[{text:'Main',key:0,isLaterAddedView:false,isViewResetEnabled:false},{text:'View 1 (default view)',key:1,initialSelectedKey:1,isLaterAddedView:false,isViewResetEnabled:false},{text:'View 2',key:2,isLaterAddedView:true,isViewResetEnabled:false}];o.newViewCounter=2;this.selectViewSwitch(e,1);}},deleteView:function(e){this.setEnablePropertyForResetAndSaveButton(true);var o=this._oCardManifestSettings,f=parseInt(o.selectedKey,10);o.tabs.splice(f-1,1);o.aViews.splice(f,1);if(f===o.defaultViewSelected){o.defaultViewSelected=1;o.aViews[f].text=o.aViews[f].text+' (default view)';}o.aViews.forEach(function(v,i){if(i>=f){v.key--;}});if(o.tabs.length==1){S.tabFields.forEach(function(t){o[t]=o.tabs[0][t];}.bind(this));delete o.selectedKey;delete o.defaultViewSelected;delete o.tabs;delete o.aViews;s.addManifestSettings(o);s.setVisibilityForFormElements(o);this.getView().getModel('visibility').refresh();this.getView().getModel().refresh();this._fCardWithRefresh();}else{o.selectedKey=1;this.selectViewSwitch(e,o.selectedKey);}},resetView:function(){var o=this._oCardManifestSettings,i=parseInt(o.selectedKey,10),e=o.aViews[i],f=o.defaultViewSelected;if(!e.isLaterAddedView){var k=o.dataPointAnnotationPath?true:false,g=this._oOriginalCardManifestSettings.dataPointAnnotationPath?true:false;if(i){var h=o.aViews[i].initialSelectedKey;S.tabFields.forEach(function(l){if(l!=='dataPointAnnotationPath'||k){if(this._oOriginalCardManifestSettings.tabs&&this._oOriginalCardManifestSettings.tabs.length){o[l]=this._oOriginalCardManifestSettings.tabs[h-1][l];}else{o[l]=this._oOriginalCardManifestSettings[l];}o.tabs[i-1][l]=o[l];}}.bind(this));if(!this._oOriginalCardManifestSettings.tabs||!this._oOriginalCardManifestSettings.tabs.length){o.newViewCounter++;o.tabs[i-1].value="View "+o.newViewCounter;}if(i===o.defaultViewSelected){o.aViews[i].text=o.tabs[i-1].value+' (default view)';}else{o.aViews[i].text=o.tabs[i-1].value;}}else{S.mainFields.forEach(function(l){o[l]=this._oOriginalCardManifestSettings[l];}.bind(this));if(k!==g){if(g){o.tabs.forEach(function(t){if(t.prevDataPointAnnotationPath){t.dataPointAnnotationPath=t.prevDataPointAnnotationPath;}else{t.dataPointAnnotationPath=o.dataPoint[0].value;}}.bind(this));o.dataPointAnnotationPath=o.tabs[f].dataPointAnnotationPath;}else{o.tabs.forEach(function(t){t.prevDataPointAnnotationPath=t.dataPointAnnotationPath;t.dataPointAnnotationPath=undefined;}.bind(this));}}}}else{var j;if(o.dataPointAnnotationPath){j=o.dataPoint[0].value;}o.newViewCounter++;if(o.template==="sap.ovp.cards.charts.analytical"){o.tabs[i-1]={chartAnnotationPath:o.chart[0].value,dataPointAnnotationPath:j,value:'View '+o.newViewCounter};}else{o.tabs[i-1]={annotationPath:o.lineItem[0].value,dataPointAnnotationPath:j,value:'View '+o.newViewCounter};}if(i===o.defaultViewSelected){o.aViews[i].text='View '+o.newViewCounter+' (default view)';}else{o.aViews[i].text='View '+o.newViewCounter;}S.tabFields.forEach(function(l){o[l]=o.tabs[i-1][l];}.bind(this));}o.isViewResetEnabled=false;o.aViews[i].isViewResetEnabled=false;s.addManifestSettings(o);s.setVisibilityForFormElements(o);this.getView().getModel('visibility').refresh();this.getView().getModel().refresh();this._fCardWithRefresh();},selectViewSwitch:function(e,f){var o=this._oCardManifestSettings;if(!f){f=e.getSource().getSelectedIndex();}if(this.defaultViewSwitch){this.defaultViewSwitch.setEnabled(true);}this.setEnablePropertyForResetAndSaveButton(true);if(!f){var i=o.defaultViewSelected;o.selectedKey=f;o.mainViewSelected=true;o.isViewResetEnabled=o.aViews[f].isViewResetEnabled;S.tabFields.forEach(function(j){o[j]=o.tabs[i-1][j];}.bind(this));s.addManifestSettings(o);s.setVisibilityForFormElements(o);this.getView().getModel('visibility').refresh();this.getView().getModel().refresh();this._fCardWithRefresh();}else{o.mainViewSelected=false;o.isViewResetEnabled=o.aViews[f].isViewResetEnabled;var g=this.getView().byId("dialogCard");if(g.getVisible()){var r=g.getComponentInstance().getRootControl();var h=r.getController();h.changeSelection(f,true,o);s.addManifestSettings(o);s.setVisibilityForFormElements(o);this.getView().getModel('visibility').refresh();this.getView().getModel().refresh();}}},setCurrentActivePageForCarouselCard:function(i){var e=this.getView().byId("dialogCard");if(e.getVisible()){var o=e.getComponentInstance(),r=o.getRootControl(),f=r.byId("pictureCarousel");if(f){var p=f.getPages(),n=p[i];f.setActivePage(n);}}},onSelectionChange:function(e){var o=e.getSource(),m=o.getModel(),f=m.getData().staticContent,g=o.getSelectedItem(),h=g.getBindingContext().getObject(),v=o.getModel("visibility");for(var i=0;i<f.length;i++){if(f[i].id===h.id){v.setProperty("/moveToTheTop",!(1===f.length||i===0));v.setProperty("/moveUp",!(1===f.length||i===0));v.setProperty("/moveDown",!(1===f.length||i===(f.length-1)));v.setProperty("/moveToTheBottom",!(1===f.length||i===(f.length-1)));v.setProperty("/delete",true);m.setProperty("/selectedItemIndex",i);v.refresh(true);break;}}},setEnablePropertyForResetAndSaveButton:function(e){s.oResetButton.setEnabled(e);s.oSaveButton.setEnabled(e);},getValueInRemString:function(v){return v+'rem';},_getSelectedItemIndex:function(m){return m.getProperty("/selectedItemIndex");},_getLastItemIndex:function(m){return this._getStaticContentArray(m).length-1;},_getStaticContentArray:function(m){return m.getProperty("/staticContent");},_setStaticContentArray:function(m,e){m.setProperty("/staticContent",e);},_setSelectedItemAndScrollToElement:function(i,h){var v=this.getView(),l=v.byId("sapOvpStaticLinkListLineItem"),o=v.byId("scrollContainer");var I=l.getItems()[i];if(h){this._oList=l;this._oItem=I;this._oScrollContainer=o;var e={onAfterRendering:function(E){this._oList.removeEventDelegate(this._oDelegateOnAfter);this._oScrollContainer.scrollToElement(this._oItem);delete this._oDelegateOnAfter;delete this._oList;delete this._oScrollContainer;delete this._oItem;}};this._oDelegateOnAfter=e;l.addEventDelegate(e,this);}else{o.scrollToElement(I);}l.setSelectedItem(I);l.fireSelectionChange();},_arrangeStaticContent:function(m,f,t){var e=this._getStaticContentArray(m);e.splice(t,0,e.splice(f,1)[0]);this._setStaticContentArray(m,e);this._setSelectedItemAndScrollToElement(t);},_filterTable:function(e,f,I){var q=e.getParameter("query"),g=null,h=[];for(var i=0;i<f.length;i++){h.push(new F(f[i],d.Contains,q));}if(q){g=new F(h,false);}this.getView().byId(I).getBinding("items").filter(g,"Application");},filterLinksTable:function(e){this._filterTable(e,["name","value"],"tableFilterLinks");},filterIconTable:function(e){this._filterTable(e,["Icon","Name"],"tableFilter");},filterImageTable:function(e){this._filterTable(e,["Name"],"tableFilterImage");},getIndexFromIdForStaticLinkList:function(i){var e=i.split("-");return e[e.length-1];},_createLabel:function(h){return new sap.m.Label({text:h});},_createIcon:function(e){return new sap.ui.core.Icon({src:"{"+e+"}"});},_createImage:function(e){return new sap.m.Image({src:"{"+e+"}",width:"3rem",height:"3rem"});},_createText:function(e){return new sap.m.Text({text:"{"+e+"}"});},_createColumnHeader:function(p){return new sap.m.Column({header:[this._createLabel(p)]});},_createColumnCells:function(t,p,i){var e;if(i==="tableFilterImage"){e=[this._createImage("Image"),this._createText("Name")];}else if(i==="tableFilterLinks"){e=[this._createText("name"),this._createText("value")];}else{e=[this._createIcon("Icon"),this._createText("Name"),this._createText("Icon")]}t.bindItems("/"+p,new sap.m.ColumnListItem({cells:e}));},_addColumnHeader:function(t,i){if(i==="tableFilterImage"){t.addColumn(this._createColumnHeader("Image"));t.addColumn(this._createColumnHeader("Name"));}else{t.addColumn(this._createColumnHeader("Icon"));t.addColumn(this._createColumnHeader("Name"));t.addColumn(this._createColumnHeader("Code"));}},_getColumnHeader:function(i){if(i==="tableFilterImage"){return[this._createColumnHeader("Image"),this._createColumnHeader("Name")];}else if(i==="tableFilterLinks"){return[this._createColumnHeader("Application Name"),this._createColumnHeader("Technical Name")];}else{return[this._createColumnHeader("Icon"),this._createColumnHeader("Name"),this._createColumnHeader("Code")];}},_createTable:function(i,f){return new sap.m.Table({id:this.getView().getId()+"--"+i,mode:sap.m.ListMode.SingleSelectLeft,inset:false,fixedLayout:false,headerToolbar:new sap.m.Toolbar({content:[new sap.m.ToolbarSpacer({width:"60%"}),new sap.m.SearchField({placeholder:"Search",search:f.bind(this)})]}),columns:this._getColumnHeader(i)});},_getImageData:function(){var i=[];i.push({'Name':'AW.png','Image':sap.ovp.cards.linklist.AnnotationHelper.formUrl(this.getView().getModel().getProperty('/baseUrl'),'img/AW.png')});return i;},_getIconData:function(I){var o=sap.ui.core.IconPool,e=o.getIconNames(),f=[];if(I){var n=I.split("://")[1],g=e.indexOf(n);e.splice(g,1);f.push({'Name':n,'Icon':o.getIconURI(n)});}for(var i=0;i<e.length;i++){f.push({'Name':e[i],'Icon':o.getIconURI(e[i])});}return f;},_getLinkListItemId:function(m,i){return m.getProperty("/staticContent/"+i+"/index");},_makeLinkListItemId:function(i){return"linkListItem--"+i;},_makeLinkListItemIndex:function(i){return"Index--"+i;},getIconAndImageDataModel:function(i){return new sap.ui.model.json.JSONModel({'Icons':this._getIconData(i),'Images':this._getImageData()});},getSubHeader:function(){var I=new sap.m.IconTabBar({selectedKey:"ICON",select:function(E){var k=E.getParameter("key");if(k==="IMAGE"){this.valueHelpDialog.setTable(this._oTableImage);if(typeof this._oTableImage.getColumns==="function"&&this._oTableImage.getColumns().length===0){this._addColumnHeader(this._oTableImage,"tableFilterImage");}}else{this.valueHelpDialog.setTable(this._oTable);if(typeof this._oTable.getColumns==="function"&&this._oTable.getColumns().length===0){this._addColumnHeader(this._oTable,"tableFilter");}}}.bind(this)});var t=["ICON","IMAGE"];for(var i=0;i<t.length;i++){var e=new sap.m.IconTabFilter({text:t[i],key:t[i]});I.addItem(e);}return new sap.m.Toolbar({content:[I]});},destroyTemplatesAndObjects:function(){var v=this.getView();var t=v.byId("tableFilterImage");if(t){t.destroy();}var o=v.byId("tableFilter");if(o){o.destroy();}var e=v.byId("tableFilterLinks");if(e){e.destroy();}delete this._oEvent;delete this._iCurrentRow;delete this._oModel;delete this._oVisibilityModel;},onExternalUrlChange:function(e){this.setEnablePropertyForResetAndSaveButton(true);},onLinkSourceChange:function(e){var o=e.getSource(),m=o.getModel(),v=o.getModel("visibility"),i=this.getIndexFromIdForStaticLinkList(o.getId()),f=e.getParameter("selectedIndex"),g=v.getProperty("/staticLink"),l=v.getProperty("/links"),I=this._getLinkListItemId(m,parseInt(i));if(f===0){g[I]=false;l[I]=true;m.setProperty("/staticContent/"+i+"/targetUri",undefined);}else{g[I]=true;l[I]=false;m.setProperty("/staticContent/"+i+"/semanticObject",undefined);m.setProperty("/staticContent/"+i+"/action",undefined);}v.setProperty("/staticLink",g);v.setProperty("/links",l);v.refresh(true);m.refresh(true);this.setEnablePropertyForResetAndSaveButton(true);},onRemoveVisualPress:function(e){var o=e.getSource(),m=o.getModel(),v=o.getModel("visibility"),i=this.getIndexFromIdForStaticLinkList(o.getId()),I=this._getLinkListItemId(m,parseInt(i)),r=v.getProperty("/removeVisual");r[I]=false;v.setProperty("/removeVisual",r);v.refresh(true);m.setProperty("/staticContent/"+i+"/imageUri",undefined);m.refresh(true);this.updateCard(e,"sapOvpSettingsStaticLinkListRemoveVisual");},createValueHelpDialogForInternalUrl:function(e){var o=e.getSource(),m=o.getModel(),E=o.getModel("staticCardProperties"),v=o.getModel("visibility"),i=this.getIndexFromIdForStaticLinkList(o.getId());this._oEvent=jQuery.extend({},e);this._iCurrentRow=i;this._oModel=m;this._oVisibilityModel=v;var t=this._createTable("tableFilterLinks",this.filterLinksTable);t.setModel(E);this._createColumnCells(t,"links","tableFilterLinks");this._oTable=t;this.valueHelpDialog=new V({title:"Application",contentWidth:"100%",contentHeight:this.getValueInRemString(s.iContentHeightForDialog),supportMultiselect:false,ok:function(e){var f=this._oTable.getSelectedItem(),I=f.getBindingContext().getProperty("value"),g=I.slice(1).split("-"),h=g[0],A=g[1];this._oModel.setProperty("/staticContent/"+this._iCurrentRow+"/semanticObject",h);this._oModel.setProperty("/staticContent/"+this._iCurrentRow+"/action",A);this._oModel.refresh(true);this.setEnablePropertyForResetAndSaveButton(true);this.destroyTemplatesAndObjects();this.valueHelpDialog.close();}.bind(this)});this.valueHelpDialog.addStyleClass("sapOvpSettingsDialogBox");this.valueHelpDialog.attachCancel(function(){this.destroyTemplatesAndObjects();this.valueHelpDialog.close();}.bind(this));this.valueHelpDialog.setTable(t);t.setSelectedItem(t.getItems()[0]);this.valueHelpDialog.open();},onChangeVisualPress:function(e){var o=e.getSource(),m=o.getModel(),v=o.getModel("visibility"),i=this.getIndexFromIdForStaticLinkList(o.getId()),I=m.getProperty("/staticContent/"+i+"/imageUri"),n=sap.ovp.cards.linklist.AnnotationHelper.isImageUrlStaticData(I);this._oEvent=jQuery.extend({},e);this._iCurrentRow=i;this._oModel=m;this._oVisibilityModel=v;var t=this._createTable("tableFilter",this.filterIconTable);var r=(n)?this.getIconAndImageDataModel():this.getIconAndImageDataModel(I);t.setModel(r);this._createColumnCells(t,"Icons","tableFilter");this._oTable=t;var f=this._createTable("tableFilterImage",this.filterImageTable);f.setModel(r);this._createColumnCells(f,"Images","tableFilterImage");this._oTableImage=f;var g=this.getSubHeader();this.valueHelpDialog=new V({title:"Visual",contentWidth:"100%",contentHeight:this.getValueInRemString(s.iContentHeightForDialog),supportMultiselect:false,ok:function(e){var t,p,h=this._getLinkListItemId(this._oModel,parseInt(this._iCurrentRow)),R=this._oVisibilityModel.getProperty("/removeVisual");R[h]=true;this._oVisibilityModel.setProperty("/removeVisual",R);this._oVisibilityModel.refresh(true);if(this._sTableName==="tableFilterImage"){t=this._oTableImage;p="Image";}else{t=this._oTable;p="Icon";}var j=t.getSelectedItem(),k=j.getBindingContext(),u=k.getProperty(p);this._oModel.setProperty("/staticContent/"+this._iCurrentRow+"/imageUri",u);this._oModel.refresh(true);this.updateCard(this._oEvent,"sapOvpSettingsStaticLinkListChangeVisual");this.destroyTemplatesAndObjects();this.valueHelpDialog.close();}.bind(this)});this.valueHelpDialog.attachSelectionChange(function(e){var h=e.getParameter("tableSelectionParams");if(h.id.indexOf("tableFilterImage")===-1){this._sTableName="tableFilter";}else{this._sTableName="tableFilterImage";}}.bind(this));this.valueHelpDialog.addStyleClass("sapOvpSettingsDialogBox");this.valueHelpDialog.attachCancel(function(){this.destroyTemplatesAndObjects();this.valueHelpDialog.close();}.bind(this));this.valueHelpDialog.setTable(t);this.valueHelpDialog.setSubHeader(g);t.setSelectedItem(t.getItems()[0]);this.valueHelpDialog.open();},handleMessagePopoverPress:function(e){s.oMessagePopOver.openBy(e.getSource());},onShowMorePress:function(e){var o=e.getSource(),m=o.getModel(),v=o.getModel("visibility"),i=this.getIndexFromIdForStaticLinkList(o.getId()),I=this._getLinkListItemId(m,parseInt(i)),f=v.getProperty("/showMore/"+I);if(f){v.setProperty("/showMore/"+I,false);}else{v.setProperty("/showMore/"+I,true);}v.refresh(true);},onPressDelete:function(e){this._oEvent=jQuery.extend({},e);M.confirm("Do you want to delete the Line Item",{actions:[sap.m.MessageBox.Action.OK,sap.m.MessageBox.Action.CANCEL],icon:M.Icon.INFORMATION,title:"Information",initialFocus:M.Action.CANCEL,onClose:function(A){if(A==="OK"){var o=this._oEvent.getSource(),v=o.getModel("visibility"),m=o.getModel(),f=this._getStaticContentArray(m),i=this._getSelectedItemIndex(m),I=this._getLinkListItemId(m,i),g=v.getProperty("/staticLink"),l=v.getProperty("/links"),r=v.getProperty("/removeVisual"),h=v.getProperty("/showMore");delete g[I];delete l[I];delete r[I];delete h[I];v.setProperty("/staticLink",g);v.setProperty("/links",l);v.setProperty("/removeVisual",r);v.setProperty("/showMore",h);f.splice(i,1);this._setStaticContentArray(m,f);m.refresh(true);if(f.length>0){this._setSelectedItemAndScrollToElement(Math.min(parseInt(i),f.length-1),true);}if(f.length<=1){v.setProperty("/delete",false);}v.refresh(true);this.updateCard(this._oEvent,"sapOvpSettingsStaticLinkListDelete");}delete this._oEvent;}.bind(this)});},onPressAdd:function(e){var o=e.getSource(),v=o.getModel("visibility"),m=o.getModel(),f=this._getStaticContentArray(m),l=m.getProperty("/lineItemIdCounter"),i=this._makeLinkListItemId(l+1),I=this._makeLinkListItemIndex(l+1),g=v.getProperty("/staticLink"),L=v.getProperty("/links"),r=v.getProperty("/removeVisual"),h=v.getProperty("/showMore");m.setProperty("/lineItemIdCounter",l+1);f.unshift({"id":i,"index":I,"title":"Default Title","subTitle":"","imageUri":"","imageAltText":"","targetUri":"","openInNewWindow":""});g[I]=true;L[I]=false;r[I]=false;h[I]=true;v.setProperty("/staticLink",g);v.setProperty("/links",L);v.setProperty("/removeVisual",r);v.setProperty("/showMore",h);v.refresh(true);this._setStaticContentArray(m,f);m.refresh(true);this._setSelectedItemAndScrollToElement(0);this.updateCard(e,"sapOvpSettingsStaticLinkListAdd");},onPressMoveToTheTop:function(e){var m=e.getSource().getModel();this._arrangeStaticContent(m,this._getSelectedItemIndex(m),0);this.updateCard(e,"sapOvpSettingsStaticLinkListSort");},onPressMoveUp:function(e){var m=e.getSource().getModel(),i=this._getSelectedItemIndex(m);this._arrangeStaticContent(m,i,i-1);this.updateCard(e,"sapOvpSettingsStaticLinkListSort");},onPressMoveDown:function(e){var m=e.getSource().getModel(),i=this._getSelectedItemIndex(m);this._arrangeStaticContent(m,i,i+1);this.updateCard(e,"sapOvpSettingsStaticLinkListSort");},onPressMoveToTheBottom:function(e){var m=e.getSource().getModel(),i=this._getSelectedItemIndex(m),I=this._getLastItemIndex(m);this._arrangeStaticContent(m,i,I);this.updateCard(e,"sapOvpSettingsStaticLinkListSort");},onResetButton:function(){this.setEnablePropertyForResetAndSaveButton(false);this._oCardManifestSettings=jQuery.extend(true,{},this._oOriginalCardManifestSettings);var o=new sap.ui.model.json.JSONModel(this._oCardManifestSettings);s.setVisibilityForFormElements(this._oCardManifestSettings);this.getView().getModel('visibility').refresh();this.getView().setModel(o);this.getView().getModel().refresh();this._fCardWithRefresh();},setBusy:function(e){if(e){this.getView().addStyleClass("dialogContainerOverlay");var f=this.getView().byId("dialogCard");if(f.getVisible()){f.getComponentInstance().getRootControl().setBusy(e);}}else{this.getView().removeStyleClass("dialogContainerOverlay");setTimeout(function(){var f=this.getView().byId("dialogCard");if(f.getVisible()){f.getComponentInstance().getRootControl().setBusy(e);}}.bind(this),2000);}},_fCardWithoutRefresh:function(e,u){var v=this.getView(),o=this._oCardManifestSettings,f=v.byId("dialogCard").getComponentInstance(),r=f.getRootControl(),E,i=false,g;if(o.tabs&&o.tabs.length){i=true;g=parseInt(o.selectedKey,10);}if(u.formElementId==="sapOvpSettingsLineItemTitle"||u.formElementId==="sapOvpSettingsLineItemSubTitle"){E=r.byId(u.cardElementId+"--"+v.getModel().getProperty("/lineItemId"));}else{E=r.byId(u.cardElementId);}switch(u.formElementId){case"sapOvpSettingsLineItemTitle":case"sapOvpSettingsLineItemSubTitle":case"sapOvpSettingsTitle":case"sapOvpSettingsValueSelectionInfo":E.setText(e.getSource().getValue());break;case"sapOvpSettingsSubTitle":var h=r.getController(),j=h.getCardPropertiesModel();j.setProperty("/subTitle",e.getSource().getValue());h._setSubTitleWithUnitOfMeasure();break;case"sapOvpViewName":var m=v.getModel(),k=o.viewName;E.getItems()[g-1].setText(k);o.tabs[g-1].value=k;if(o.defaultViewSelected===g){k=k+" (default view)";}o.aViews[g].text=k;m.refresh();break;case"sapOvpDefaultViewSwitch":if(e.getSource().getState()){var l=o.defaultViewSelected,m=v.getModel();o.defaultViewSelected=g;o.aViews[l].text=o.tabs[l-1].value;o.aViews[g].text+=" (default view)";m.refresh();this.defaultViewSwitch=e.getSource();this.defaultViewSwitch.setEnabled(false);}break;case"sapOvpSettingsIdentification":if(i){o.tabs[g-1][u.updateProperty]=o[u.updateProperty];}break;case"sapOvpSettingsKPIHeaderSwitch":var n=v.getModel("visibility"),p=n.getData();p.dataPoint=false;p.valueSelectionInfo=false;if(i){o.tabs.forEach(function(t){t.prevDataPointAnnotationPath=t.dataPointAnnotationPath;t.dataPointAnnotationPath=undefined;});}else{var q=o.dataPointAnnotationPath;if(q){o.prevDataPointAnnotationPath=q;}o.dataPointAnnotationPath=undefined;}n.refresh(true);E.destroy();break;default:break;}},_fCardWithRefresh:function(e,u){var p,f,v,o,g,h=this._oCardManifestSettings,i=this.getView(),j=i.byId('dialogCard'),k=j.getComponentInstance().getComponentData(),l=k.cardId,m=k.manifest.cards[l].model,n={cards:{}},q=false,r;if(h.tabs&&h.tabs.length){q=true;r=parseInt(h.selectedKey,10);}switch(u){case"subTitleSwitch":v=this.getView();o=v.getModel("visibility");if(e.getSource().getState()){if(q){f=h.defaultViewSelected;h.tabs.forEach(function(w){p=w.prevDynamicSubtitleAnnotationPath;if(p){w.dynamicSubtitleAnnotationPath=p;}else{w.dynamicSubtitleAnnotationPath=h.dynamicSubTitle[0].value;}}.bind(this));h.dynamicSubtitleAnnotationPath=h.tabs[f-1].dynamicSubtitleAnnotationPath;}else{p=h.prevDynamicSubtitleAnnotationPath;if(p){h.dynamicSubtitleAnnotationPath=p;}else{h.dynamicSubtitleAnnotationPath=h.dynamicSubTitle[0].value;}}i.byId("sapOvpSettingsDynamicSubTitle").setSelectedKey(h.dynamicSubtitleAnnotationPath);}else{if(q){h.tabs.forEach(function(w){w.prevDynamicSubtitleAnnotationPath=w.dynamicSubtitleAnnotationPath;w.dynamicSubtitleAnnotationPath=undefined;});h.dynamicSubtitleAnnotationPath=undefined;}else{var t=h.dynamicSubtitleAnnotationPath;if(t){h.prevDynamicSubtitleAnnotationPath=t;}h.dynamicSubtitleAnnotationPath=undefined;}}o.setProperty("/subTitle",s.getVisibilityOfElement(h,'subTitle',q));o.setProperty("/dynamicSubTitle",s.getVisibilityOfElement(h,'dynamicSubTitle',q)&&!!h["dynamicSubTitle"]&&!!h["dynamicSubTitle"].length);o.refresh(true);break;case"kpiHeader":v=this.getView();o=v.getModel("visibility");g=o.getData();g.valueSelectionInfo=true;g.dataPoint=true;if(h.tabs&&h.tabs.length){g.dataPoint=s.getVisibilityOfElement(h,'dataPoint',true);}if(!h.valueSelectionInfo){h.valueSelectionInfo=" ";}if(q){f=h.defaultViewSelected;h.tabs.forEach(function(w){p=w.prevDataPointAnnotationPath;if(p){w.dataPointAnnotationPath=p;}else{w.dataPointAnnotationPath=h.dataPoint[0].value;}}.bind(this));h.dataPointAnnotationPath=h.tabs[f-1].dataPointAnnotationPath;}else{p=h.prevDataPointAnnotationPath;if(p){h.dataPointAnnotationPath=p;}else{h.dataPointAnnotationPath=h.dataPoint[0].value;}}o.refresh(true);break;case"listType":e.getSource().getState()?(h[u]="extended"):(h[u]="condensed");break;case"listFlavor":e.getSource().getState()?(h[u]="bar"):(h[u]="");break;case"sortBy":v=this.getView();o=v.getModel("visibility");g=o.getData();if(!!h.sortBy!==g.sortOrder){g.sortOrder=!!h.sortBy;o.refresh();}case"listFlavorForLinkList":case"sortOrder":break;case"annotationPath":case"chartAnnotationPath":case"presentationAnnotationPath":case"selectionAnnotationPath":break;case"dataPointAnnotationPath":if(q){h.tabs[r-1][u]=h[u];}break;case"add":case"removeVisual":case"changeVisual":case"sort":case"delete":break;default:break;}n.cards[l]={model:m,template:k.template,settings:h};this.setBusy(true);var P=c.createCardComponent(i,n,'dialogCard');P.then(function(){this.setBusy(false);}.bind(this));P.catch(function(){this.setBusy(false);}.bind(this));},updateCard:function(e,I){var o=this._oCardManifestSettings,f=this.getView().byId("dialogCard");this.setEnablePropertyForResetAndSaveButton(true);if(f.getVisible()){if(o.tabs&&o.tabs.length){var g=parseInt(o.selectedKey,10);o.isViewResetEnabled=true;o.aViews[g].isViewResetEnabled=true;}var h=e.getSource(),k=(I)?I:h.getId(),l=false;if(k.indexOf("sapOvpStaticLinkListLineItem")!==-1){var m=h.getModel(),n=m.getData().staticContent,p=this.getIndexFromIdForStaticLinkList(k);this.setCurrentActivePageForCarouselCard(p);m.setProperty("/lineItemId",n[p].id);if(k.indexOf("sapOvpSettingsLineItemTitle")!==-1){k="sapOvpSettingsLineItemTitle";}else if(k.indexOf("sapOvpSettingsLineItemSubTitle")!==-1){k="sapOvpSettingsLineItemSubTitle";}}for(var i=0;i<this._aRefreshNotRequired.length;i++){if(k.indexOf(this._aRefreshNotRequired[i].formElementId)>-1){if(this._aRefreshNotRequired[i].isKpiSwitch&&e.getSource().getState()){break;}this._fCardWithoutRefresh(e,this._aRefreshNotRequired[i]);l=true;break;}}if(!l){for(var j=0;j<this._aRefreshRequired.length;j++){if(k.indexOf(this._aRefreshRequired[j].formElementId)>-1){this.setBusy(true);this._fCardWithRefresh(e,this._aRefreshRequired[j].updateProperty);break;}}}}},onExit:function(){s.oSaveButton.detachPress(this.createAndSubmitChange,this);s.oResetButton.detachPress(this.createAndSubmitChange,this);},updateTheLineItemSelected:function(e){var f=e.getSource().getSelectedItem().getBindingContext().getObject().Qualifier,o=this._oCardManifestSettings,i;if(o.tabs&&o.tabs.length){i=parseInt(o.selectedKey,10);}o.lineItemQualifier=f;o.annotationPath='com.sap.vocabularies.UI.v1.LineItem#'+f;if(f==='Default'){o.annotationPath='com.sap.vocabularies.UI.v1.LineItem';}if(o.tabs&&o.tabs.length){o.tabs[i-1].annotationPath=o.annotationPath;}this.getView().byId("sapOvpSettingsLineItem").setValue(f);this._fCardWithRefresh(e,'annotationPath');this.setEnablePropertyForResetAndSaveButton(true);if(o.tabs&&o.tabs.length){o.isViewResetEnabled=true;o.aViews[i].isViewResetEnabled=true;}this.valueHelpDialog.close();},getListItems:function(){var i=[],o=this._oCardManifestSettings,e=this.getView(),f=e.byId('dialogCard'),g=f.getComponentInstance().getComponentData(),l=o.entityType.$path+'/'+o.annotationPath,m=g.model.getMetaModel(),h=m.getContext(m.resolve(l,this.oView.getBindingContext()));var j=2,k=1,n=0;if(o.listFlavor==='bar'){j=1;k=2;}if(o.listType&&o.listType.toLowerCase()==='extended'){j=6;k=3;n=3;if(o.listFlavor==='bar'){j=5;}}else if(o.contentFragment==="sap.ovp.cards.table.Table"){j=3;k=1;n=1;}o.lineItem.forEach(function(p){var q=sap.ovp.cards.AnnotationHelper.getSortedDataPoints(h,p.fields),r=sap.ovp.cards.AnnotationHelper.getSortedDataFields(h,p.fields),t=[],u=[];q.forEach(function(y){if(y.Title){u.push(y.Title.String);}});r.forEach(function(y){if(y.Label){t.push(y.Label.String);}});var v=Math.min(u.length,k),w=Math.min(n,v),x=t.slice(0,j-w).concat(u.slice(0,v));x.map(function(y){return y.charAt(0).toUpperCase()+y.substr(1);});i.push({Qualifier:p.name,VisibleFields:x.toString()});});return i;},openLineItemValueHelpDialog:function(e){var t=new sap.m.Table({mode:sap.m.ListMode.SingleSelectLeft,inset:false,fixedLayout:false,columns:[new sap.m.Column({header:[new sap.m.Label({text:sap.ui.getCore().getLibraryResourceBundle("sap.ovp").getText('OVP_KEYUSER_LINEITEM_QUAL')})]}),new sap.m.Column({header:[new sap.m.Label({text:sap.ui.getCore().getLibraryResourceBundle("sap.ovp").getText("OVP_KEYUSER_VISIBLE_FIELDS")})]})]});t.bindItems("/",new sap.m.ColumnListItem({cells:[new sap.m.Text({text:"{Qualifier}"}),new sap.m.Text({text:"{VisibleFields}"})]}));t.attachSelectionChange(this.updateTheLineItemSelected.bind(this));this.valueHelpDialog=new V({title:sap.ui.getCore().getLibraryResourceBundle("sap.ovp").getText("OVP_KEYUSER_LINEITEM_ANNO"),contentWidth:"100%",contentHeight:this.getValueInRemString(s.iContentHeightForDialog+0.125),supportMultiselect:false});this.valueHelpDialog.attachCancel(function(){this.valueHelpDialog.close();}.bind(this));this.valueHelpDialog.setTable(t);this.valueHelpDialog.addStyleClass("sapOvpSettingsDialogBox");this.aItemList=this.getListItems();var r=new sap.ui.model.json.JSONModel();r.setData(this.aItemList);this.valueHelpDialog.getTable().setModel(r);t.getItems().forEach(function(i){if(i.getBindingContext().getObject().Qualifier===this._oCardManifestSettings.lineItemQualifier){i.setSelected(true);}}.bind(this));this.valueHelpDialog.open();},generateId:function(e,p,P){return s.sApplicationId+"_sap.ovp.cards."+e+"."+p+"."+P;},createTranslationTextObject:function(v){return{"type":"XTIT","maxLength":40,"value":{"":v,"en":v}};},createAndSubmitChange:function(){var i,j,k,p,e,o,t,O,f,P={card:{}},g=jQuery.extend(true,{},s.oAppDescriptor),h={};var l="customer."+g.id;h.cardId=l;delete g.id;delete g.settings.baseUrl;if(g.settings["staticContent"]){for(i=0;i<g.settings["staticContent"].length;i++){delete g.settings["staticContent"][i].id;}}e=this._oCardManifestSettings["staticContent"];o=this._oOriginalCardManifestSettings["staticContent"];if(e&&o){if(e.length<o.length){g.settings["staticContent"].splice(e.length,o.length-e.length);}else if(e.length>o.length){for(i=0;i<e.length-o.length;i++){g.settings["staticContent"].push({});}}}t=this._oCardManifestSettings["tabs"];if(!t){delete this._oCardManifestSettings.selectedKey;}O=this._oOriginalCardManifestSettings["tabs"];if(t||O){if(!t){if(g.settings["tabs"]){delete g.settings["tabs"];}}else if(!O||t.length>O.length){var m;if(!O){m=t.length;g.settings["tabs"]=[];}else{m=t.length-O.length;}for(i=0;i<m;i++){g.settings["tabs"].push({});}}else if(t.length<O.length){g.settings["staticContent"].splice(t.length,O.length-t.length);}}h.settings=jQuery.extend(true,{},g.settings);var n=S.cardSettingsWithText;for(i=0;i<n.length;i++){var I;if(typeof n[i]=="string"){if(this._oCardManifestSettings[n[i]]!=this._oOriginalCardManifestSettings[n[i]]){if(this._oCardManifestSettings[n[i]]){if(!f){f={};}I=this.generateId(l,"settings",n[i]);if(this._oCardManifestSettings[n[i]]){g.settings[n[i]]="{{"+I+"}}";h.settings[n[i]]=this._oCardManifestSettings[n[i]];f[I]=this.createTranslationTextObject(this._oCardManifestSettings[n[i]]);}}else{delete g.settings[n[i]];delete h.settings[n[i]];}}}else if(typeof n[i]=="object"){if(n[i].hasOwnProperty("staticContent")){if(e&&o){for(j=0;j<e.length;j++){for(k=0;k<n[i]["staticContent"].length;k++){p=n[i]["staticContent"][k];if(j>=o.length||e[j][p]!=o[j][p]){if(!f){f={};}I=this.generateId(l,"settings.staticContent_"+j,p);if(e[j][p]){g.settings["staticContent"][j][p]="{{"+I+"}}";h.settings["staticContent"][j][p]=e[j][p];f[I]=this.createTranslationTextObject(e[j][p]);}}}}}}else if(n[i].hasOwnProperty("tabs")){if(t||O){if(t){for(j=0;j<t.length;j++){for(k=0;k<n[i]["tabs"].length;k++){p=n[i]["tabs"][k];if(!O||j>=O.length||t[j][p]!=O[j][p]){if(!f){f={};}I=this.generateId(l,"settings.tabs_"+j,p);if(t[j][p]){g.settings["tabs"][j][p]="{{"+I+"}}";h.settings["tabs"][j][p]=t[j][p];f[I]=this.createTranslationTextObject(t[j][p]);}}}}}}}}}var q=S.cardSettingsWithOutText;for(i=0;i<q.length;i++){if(typeof q[i]=="string"){if(this._oCardManifestSettings[q[i]]!=this._oOriginalCardManifestSettings[q[i]]){if(this._oCardManifestSettings[q[i]]){g.settings[q[i]]=this._oCardManifestSettings[q[i]];h.settings[q[i]]=this._oCardManifestSettings[q[i]];}else{delete g.settings[q[i]];delete h.settings[q[i]];}}}else if(typeof q[i]=="object"){if(q[i].hasOwnProperty("staticContent")){if(e&&o){for(j=0;j<e.length;j++){for(k=0;k<q[i]["staticContent"].length;k++){p=q[i]["staticContent"][k];if(j>=o.length||e[j][p]!=o[j][p]){if(e[j][p]){g.settings["staticContent"][j][p]=e[j][p];h.settings["staticContent"][j][p]=e[j][p];}else{delete g.settings["staticContent"][j][p];delete h.settings["staticContent"][j][p];}}}}}}else if(q[i].hasOwnProperty("tabs")){if(t||O){if(t){for(j=0;j<t.length;j++){for(k=0;k<q[i]["tabs"].length;k++){p=q[i]["tabs"][k];if(!O||j>=O.length||t[j][p]!=O[j][p]){if(t[j][p]){g.settings["tabs"][j][p]=t[j][p];h.settings["tabs"][j][p]=t[j][p];}else{delete g.settings["tabs"][j][p];delete h.settings["tabs"][j][p];}if(!O){delete g.settings[p];delete h.settings[p];}}}}}}}}}P.card[l]=g;var r={};r['appDescriptorChange']={'parameters':P};if(f){r['appDescriptorChange']['texts']=f;}r['flexibilityChange']=h;r['deleteCard']={'parameters':{'cardId':l}};this.settingsResolve(r);s.dialogBox.close();}});});
