-sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/odata/ODataUtils","sap/ovp/cards/generic/Component","sap/ui/generic/app/navigation/service/NavigationHandler","sap/m/MessageBox","sap/ovp/cards/CommonUtils","sap/ovp/cards/PersonalizationUtils","sap/ushell/ui/footerbar/AddBookmarkButton","sap/m/BusyDialog","sap/ui/model/resource/ResourceModel","sap/ui/model/Filter","sap/ui/comp/smartvariants/SmartVariantManagement","sap/ui/comp/smartvariants/PersonalizableInfo","sap/ui/generic/app/navigation/service/SelectionVariant","sap/ui/comp/state/UIState","sap/m/ColumnListItem","sap/m/Text","sap/m/Switch","sap/m/Table","sap/m/Column","sap/m/Button","sap/m/Dialog","sap/ui/model/json/JSONModel"],function(C,O,a,N,M,b,P,A,B,R,F,S,c,d,U,f,T,g,h,m,n,D,J){"use strict";return C.extend("sap.ovp.app.Main",{getCustomAppStateDataExtension:function(o){},restoreCustomAppStateDataExtension:function(o){},getCustomFilters:function(){},onCustomActionPress:function(s){},onCustomParams:function(s){},oRefreshTimer:null,nRefreshInterval:0,filterItemInFocus:null,storeIncomingDeltaChanges:function(e){this.deltaCardsInfo=e?e:[];},appendIncomingDeltaChange:function(o){this.deltaChanges.push(o);},onInit:function(){this.bDeltaChangesEnabled=false;this.deltaChanges=[];this.oCardsModels={};this.aFilters=[];this.errorHandlingObject={atLeastOneRequestSuccess:false,errorLoadingTimeout:{}};this.sPreviousEntityType="";this.sCurrentEntityType="";this.oLoadedComponents={};this.bGlobalFilterLoaded=false;this.bGoButtonPressed=false;jQuery.sap.measure.start("ovp:GlobalFilter","Main Controller init -> Global Filter loaded","ovp");jQuery.sap.measure.start("ovp:Personalization","Main Controller init -> Personalization loaded","ovp");this.isInitialLoading=true;var u=this.getUIModel();this.oValueHelpMap=u&&u.getProperty("/ValueHelpEntityMap");this.oNavigationHandler=this.oNavigationHandler||new N(this);this._initFlexibilityPersonalization();this.getLayout().addStyleClass("ovpLayoutElement");this.oState={};this.oState.oSmartFilterbar=this.byId("ovpGlobalFilter");this._initGlobalFilter();this._createModelForTile();sap.ovp.cards.CommonUtils.enable(this,this.oNavigationHandler);},performRecreationOfCard:function(o){this.createLoadingCard(o);o.settings.baseUrl=this._getBaseUrl();this._clearStoredEntities();this._initCardModel(o.model);this._loadCardComponent(o.template);this._createModelViewMap(o);jQuery.when(this.createCard(o)).then(function(){if(this.getLayout().getMetadata().getName()==="sap.ovp.ui.DashboardLayout"){var e=this.getLayout().getDashboardLayoutUtil();if(e){var i=e.getDashboardLayoutModel();var j=i.getCardById(o.id);j.dashboardLayout.autoSpan=false;e._sizeCard(j);i.extractCurrentLayoutVariant();}}}.bind(this));},recreateCard:function(s){var o=this._getCardFromManifest(s.cardId);if(o.template=="sap.ovp.cards.charts.analytical"){o.settings.chartAnnotationPath=s.chartAnnotationPath;o.settings.navigation=s.navigation;}o.settings.annotationPath=s.annotationPath;o.settings.dynamicSubtitleAnnotationPath=s.dynamicSubtitleAnnotationPath;o.settings.presentationAnnotationPath=s.presentationAnnotationPath;o.settings.selectionAnnotationPath=s.selectionAnnotationPath;o.settings.selectionPresentationAnnotationPath=s.selectionPresentationAnnotationPath;o.settings.dataPointAnnotationPath=s.dataPointAnnotationPath;o.settings.identificationAnnotationPath=s.identificationAnnotationPath;o.settings.headerAnnotationPath=s.headerAnnotationPath;var e=o.settings.selectedKey;o.settings.selectedKey=s.selectedKey;if(o){this.performRecreationOfCard(o);}var i={changeType:"viewSwitch",content:{cardId:s.cardId,selectedKey:s.selectedKey,oldKey:e},isUserDependent:true};this.savePersonalization(i);},recreateRTAClonedCard:function(o){var e=this._getCardFromManifest(o.cardId);if(e){e.settings=o.settings;this.performRecreationOfCard(e);}},onBeforeRendering:function(){},onAfterRendering:function(){this.oModelViewMap={};this.oAppStatePromise=null;if(this.getView().getModel("ui").getProperty("/refreshIntervalInMinutes")){this.nRefreshInterval=this.getView().getModel("ui").getProperty("/refreshIntervalInMinutes");this.nRefreshInterval=(this.nRefreshInterval<=1?1:this.nRefreshInterval)*60000;}if(this.getView()&&this.getView().byId('ovpErrorPage')){jQuery(this.getView().byId('ovpErrorPage').getDomRef()).hide();}if(this.initialized){return;}this.initialized=true;this.oFlexibilityPersonalizationPromise.then(function(){jQuery.sap.measure.end("ovp:Personalization");this.persistencyVariantLoaded=true;var o;var e=[],i=[];this.aManifestOrderedCards=this._getCardArrayAsVariantFormat(this.getLayout().getContent());for(var j=0;j<this.aManifestOrderedCards.length;j++){o=this._getCardFromManifest(this.aManifestOrderedCards[j].id);if(o&&o.settings&&o.settings.requireAppAuthorization){e.push({id:o.id,cardIntent:o.settings.requireAppAuthorization});i.push(o.settings.requireAppAuthorization);}}if(i.length>0){this._checkForAuthorization(e,i);}else{this.aOrderedCards=this._mergeLREPContent(this.aManifestOrderedCards);this.organizeCards(this.aOrderedCards);}}.bind(this),function(e){jQuery.sap.log.error("Could not load information from LREP Persistency");jQuery.sap.log.error(e);});if(sap.ui.Device.system.phone){jQuery.sap.require("sap.ovp.ui.SmartphoneHeaderToggle");sap.ovp.ui.SmartphoneHeaderToggle.enable(this);}setTimeout(function(){if(!this.persistencyVariantLoaded){this.busyDialog=new B({text:this._getLibraryResourceBundle().getText("loading_dialog_text")});this.busyDialog.open();this.busyDialog.addStyleClass('sapOVPBusyDialog');}}.bind(this),500);},organizeCards:function(o){var e;var v=[];this._updateLayoutWithOrderedCards();this._updateDashboardLayoutCards(o);if(this.isDragAndDropEnabled()){this._initShowHideCardsButton();}this._clearStoredEntities();for(var i=0;i<this.aOrderedCards.length;i++){if(this.aOrderedCards[i].visibility){e=this._getCardFromManifest(this.aOrderedCards[i].id);if(e){v.push(e);}}}for(var i=0;i<v.length;i++){this._initCardModel(v[i].model);this._loadCardComponent(v[i].template);this._createModelViewMap(v[i]);}jQuery.sap.measure.start("ovp:CreateLoadingCards","Create Loading cards","ovp");for(var i=0;i<v.length;i++){this.createLoadingCard(v[i]);}jQuery.sap.measure.end("ovp:CreateLoadingCards");setTimeout(function(){this.getLayout().addStyleClass("ovpLayoutElementShow");}.bind(this),0);setTimeout(function(){jQuery.sap.measure.start("ovp:CreateCards","Create cards loop","ovp");for(var i=0,j=0;j<v.length;i++,j++){while(v[j].id!==o[i].id){i++;}e=v[j];if(!e.settings.title){jQuery.sap.log.error("title is mandatory for card ID : "+e.id);}if(e.settings.tabs){var I=0;if(this.aOrderedCards[i].selectedKey){I=this.aOrderedCards[i].selectedKey-1;}this.initializeTabbedCard(e,I);}e.settings.baseUrl=this._getBaseUrl();this.createCard(e);}jQuery.sap.measure.end("ovp:CreateCards");}.bind(this),10);if(this.busyDialog){this.busyDialog.close();}},_createModelViewMap:function(o){if(!o||!o.settings||!o.model){return;}if(!o.settings.entitySet||o.settings.entitySet===""){return;}var s=o.model;if(!this.oModelViewMap[s]){this.oModelViewMap[s]={};}this.oModelViewMap[s][o.id]=true;},initializeTabbedCard:function(o,i){if(o.template=="sap.ovp.cards.charts.analytical"){o.settings.chartAnnotationPath=o.settings.tabs[i].chartAnnotationPath;o.settings.navigation=o.settings.tabs[i].navigation;}o.settings.annotationPath=o.settings.tabs[i].annotationPath;o.settings.dynamicSubtitleAnnotationPath=o.settings.tabs[i].dynamicSubtitleAnnotationPath;o.settings.presentationAnnotationPath=o.settings.tabs[i].presentationAnnotationPath;o.settings.selectionAnnotationPath=o.settings.tabs[i].selectionAnnotationPath;o.settings.selectionPresentationAnnotationPath=o.settings.tabs[i].selectionPresentationAnnotationPath;o.settings.dataPointAnnotationPath=o.settings.tabs[i].dataPointAnnotationPath;o.settings.identificationAnnotationPath=o.settings.tabs[i].identificationAnnotationPath;o.settings.params=o.settings.tabs[i].params;o.settings.selectedKey=i+1;},_getLibraryResourceBundle:function(){if(!this.oLibraryResourceBundle){this.oLibraryResourceBundle=sap.ui.getCore().getLibraryResourceBundle("sap.ovp");}return this.oLibraryResourceBundle;},_getOvplibResourceBundle:function(){if(!this.ovplibResourceBundle){var r=sap.ui.getCore().getLibraryResourceBundle("sap.ovp");this.ovplibResourceBundle=r?new R({bundleUrl:r.oUrlInfo.url}):null;}return this.ovplibResourceBundle;},_getCardsModel:function(){if(!this.oCards){var u=this.getUIModel();this.oCards=u.getProperty("/cards");}return this.oCards;},_getBaseUrl:function(){var u=this.getUIModel();if(!this.sBaseUrl){this.sBaseUrl=u.getProperty("/baseUrl");}return this.sBaseUrl;},_getApplicationId:function(){var u=this.getUIModel();return u.getProperty("/applicationId");},_getCardFromManifest:function(s){var e=this._getCardsModel();for(var i=0;i<e.length;i++){if(e[i].id===s){return e[i];}}return null;},_getCardArrayAsVariantFormat:function(e){var j=[];for(var i=0;i<e.length;i++){var I=this._getCardId(e[i].getId());j.push({id:I,visibility:e[i].getVisible()});var s;if(this.getView()&&this.getView().byId){if(this.getView().byId(I).getComponentInstance()){s=this.getView().byId(I).getComponentInstance().getComponentData().settings.selectedKey;}}if(s){j[j.length-1].selectedKey=s;}}return j;},_checkForAuthorization:function(e,o){var t=this;var u=[];var p=sap.ovp.cards.CommonUtils.getNavigationHandler();if(p&&p.oCrossAppNavService){p.oCrossAppNavService.isIntentSupported(o).done(function(r){for(var i=0;i<e.length;i++){if(r[e[i].cardIntent].supported===false){u.push(e[i].id);for(var j=0;j<t.aManifestOrderedCards.length;j++){if(e[i].id===t.aManifestOrderedCards[j].id){t.aManifestOrderedCards.splice(j,1);break;}}}}t.aOrderedCards=t._mergeLREPContent(t.aManifestOrderedCards);for(var k=0;k<u.length;k++){for(var l=0;l<t.aOrderedCards.length;l++){if(t.aOrderedCards[l].id==u[k]){t.aOrderedCards.splice(l,1);if(t.getLayout().getMetadata().getName()==="sap.ovp.ui.DashboardLayout"){t.getLayout().dashboardLayoutUtil.aCards.filter(function(q,s){if(q.id===u[k]){t.getLayout().dashboardLayoutUtil.aCards.splice(s,1);}});t.getLayout().dashboardLayoutUtil.dashboardLayoutModel.oLayoutVars.filter(function(q,s){if(q.id===u[k]){t.getLayout().dashboardLayoutUtil.dashboardLayoutModel.oLayoutVars.splice(s,1);}});}break;}}}t.organizeCards(t.aOrderedCards);}).fail(function(){jQuery.sap.log.error("Could not get authorization from isIntentSupported");t.aOrderedCards=t._mergeLREPContent(t.aOrderedCards);t.organizeCards(t.aOrderedCards);});}},_mergeLREPContent:function(l){var e=[];var u=this.getUIModel();var i=false;if(this.bDeltaChangesEnabled&&Array.isArray(this.deltaCardsInfo)&&this.deltaCardsInfo.length>0){l=P.addMissingCardsFromManifest(l,this.deltaCardsInfo);i=true;}if(this.getLayout().getMetadata().getName()==="sap.ovp.ui.DashboardLayout"){if(!i){l=this.getLayout().getLayoutDataJSON();}e=P.mergeChanges(l,this.deltaChanges);this._bDashboardLayoutLrepActive=true;this.getLayout().getDashboardLayoutModel().setLayoutVars(e);}else{e=P.mergeChanges(l,this.deltaChanges);}return e?e:[];},_updateLayoutWithOrderedCards:function(){var l=this.getLayout();var o=this.aOrderedCards;l.removeAllContent();var e,k=false;if(this.getView().getModel("ui")&&this.getView().getModel("ui").getProperty("/cards")){e=this.getView().getModel("ui").getProperty("/cards");for(var i=0;i<e.length;i++){k=false;for(var j=0;j<o.length;j++){if(e[i].id==o[j].id){k=true;break;}}if(!k&&this.getView().byId(e[i].id)){this.getView().byId(e[i].id).destroy();}}}for(var i=0;i<o.length;i++){var p=this.getView().byId(o[i].id);if(p){p.setVisible(o[i].visibility);l.addContent(p);}}},_updateDashboardLayoutCards:function(e){if(this.getLayout().getMetadata().getName()==="sap.ovp.ui.DashboardLayout"){if(this.getLayout().getDashboardLayoutUtil()){this.getLayout().getDashboardLayoutUtil().updateCardVisibility(e);}}},_resetDashboardLayout:function(){if(this.getLayout().getMetadata().getName()==="sap.ovp.ui.DashboardLayout"){if(this.getLayout().getDashboardLayoutUtil()){this.getLayout().getDashboardLayoutUtil().resetToManifest();}this.getLayout().rerender();}},_getCardArrayAsVariantFormatDashboard:function(){var e=[];var l=this.getLayout();var i=l.dashboardLayoutUtil.aCards;l.dashboardLayoutUtil.dashboardLayoutModel._sortCardsByRow(i);i.forEach(function(j){e.push({id:j.id,visibility:j.dashboardLayout.visible});});return e;},verifyGlobalFilterLoaded:function(){var G=this.getGlobalFilter();if(G.search()){if(G.validateMandatoryFields()){return true;}}this.getView().byId("ovpMain").setHeaderExpanded(true);return false;},onGlobalFilterChange:function(){this.filterChanged=true;},onGlobalFilterSearch:function(){if(this.filterChanged||this.bGoButtonPressed){var G=this.getGlobalFilter();if(G&&!G.isDialogOpen()){this._storeCurrentAppStateAndAdjustURL();}this._clearStoredEntities();var e=[];if(this.oGlobalFilter['_aFields'].length>0){e=this.oGlobalFilter["_aFields"];}else{var k=this.oGlobalFilter['_aFilterBarViewMetadata'];for(var i=0;i<k.length;i++){var l=k[i];for(var j=0;j<l.fields.length;j++){e.push(l.fields[j]);}}}for(var i=0;i<e.length;i++){if(e[i].control){var o=document.getElementById(e[i].control.sId);if(jQuery(o).hasClass('sapMFocus')){this.filterItemInFocus=e[i].control;break;}}}var s="ovp-"+new Date().getTime();for(var p in this.oCardsModels){if(this.oCardsModels.hasOwnProperty(p)){try{this.oCardsModels[p].refresh(false,false,s);}catch(q){jQuery.sap.log.warning(q);}}}this.filterChanged=false;this.bGoButtonPressed=false;this._clearStoredEntities();}},_clearStoredEntities:function(){if(this.sPreviousEntityType){this.sPreviousEntityType="";}if(this.sCurrentEntityType){this.sCurrentEntityType="";}},_processFilters:function(){this.aFilters=[];var G=this.getGlobalFilter();if(!G){return;}var e=G.getFilters();var o=this.getCustomFilters();if(o&&(o instanceof sap.ui.model.Filter)){if(o){var i=[];if(e&&e.length>0){i.push(new F([e[0],o],true));}else{i.push(o);}if(i.length>0){e=i;}}}this.aFilters=e;},_initGlobalFilter:function(){var G=this.getGlobalFilter();if(!G){this.bGlobalFilterLoaded=true;this._parseNavigationVariant();jQuery.sap.measure.end("ovp:GlobalFilter");return;}G.attachFiltersDialogClosed(this._storeCurrentAppStateAndAdjustURL.bind(this));var v=G.getVariantManagement();if(v){v.attachAfterSave(function(e){this._storeCurrentAppStateAndAdjustURL();}.bind(this));}this.oGlobalFilterLoadedPromise=new Promise(function(r,e){G.attachInitialized(function(){this._parseNavigationVariant();if(this.oParseNavigationPromise){this.oParseNavigationPromise.done(function(o,u,s){if(o){this._setNavigationVariantToGlobalFilter(o,u,s);this.filterChanged=false;}}.bind(this));this.oParseNavigationPromise.fail(function(){jQuery.sap.log.error("Could not parse navigation variant from URL");});this.oParseNavigationPromise.always(function(){if(G&&this.verifyGlobalFilterLoaded()){r();}}.bind(this));}else{if(G&&this.verifyGlobalFilterLoaded()){r();}}},this);G.attachSearch(function(){if(!this.bGlobalFilterLoaded){r();this.bGlobalFilterLoaded=true;if(!G.isDialogOpen()){this._storeCurrentAppStateAndAdjustURL();}return;}this.onGlobalFilterSearch();},this);G.attachFilterChange(this.onGlobalFilterChange,this);G._oSearchButton&&G._oSearchButton.attachPress(function(){this.bGoButtonPressed=true;}.bind(this));}.bind(this));this.oGlobalFilterLoadedPromise.then(function(V){this.bGlobalFilterLoaded=true;jQuery.sap.measure.end("ovp:GlobalFilter");}.bind(this));},onShareButtonPress:function(e){var l=this._getLibraryResourceBundle();var u=this.getUIModel();var t=u&&u.getProperty("/title");if(!this._oShareActionButton){this._oShareActionButton=sap.ui.xmlfragment("sap.ovp.app.SharePage",{shareEmailPressed:function(){sap.m.URLHelper.triggerEmail(null,l.getText("Email_Subject",[t]),document.URL);}.bind(this)});this.getView().addDependent(this._oShareActionButton);}this._oShareActionButton.openBy(e.getSource());},_createModelForTile:function(){var u=this.getUIModel();var H,t=u&&u.getProperty("/title");var o={tileTitle:t,tileCustomURL:function(){H=hasher.getHash();return H?("#"+H):window.location.href;}};if(u){u.setProperty("/tileInfo",o);}},_loadCardComponent:function(s){if(!this.oLoadedComponents[s]){jQuery.sap.measure.start("ovp:CardComponentLoad:"+s,"Card Component load","ovp");this.oLoadedComponents[s]=sap.ui.component.load({name:s,url:jQuery.sap.getModulePath(s),async:true});this.oLoadedComponents[s].then(function(){jQuery.sap.measure.end("ovp:CardComponentLoad:"+s);});}},_initCardModel:function(s){var e=false;if(this.oCardsModels[s]||!s){return;}this.oCardsModels[s]=this.getView().getModel(s);if(!this.oCardsModels[s].bUseBatch){this.oCardsModels[s].setUseBatch(false);}else{this.oCardsModels[s].setUseBatch(true);}if(this.getGlobalFilter()){e=true;}this._overrideCardModelRead(this.oCardsModels[s],e);},toggleFilterBar:function toggleFilterBar(){var G=this.getGlobalFilter();function t(k,l,o){l.height(o);k.css('top',0);}function i(k,l,o){l.height(0);k.css("top","-"+o+"px");}var j=G.getVisible();if((sap.ui.Device.system.phone)||(sap.ui.Device.system.tablet)){G.setVisible(!j);return;}if(toggleFilterBar.animationInProcess){return;}toggleFilterBar.animationInProcess=true;if(j){var k=jQuery(G.getDomRef());var l=jQuery(this.getView().byId("ovpGlobalFilterWrapper").getDomRef());var o=l.height();t(k,l,o);l.height();l.one('transitionend',function(e){G.setVisible(false);toggleFilterBar.animationInProcess=false;});i(k,l,o);}else{G.setVisible(true);setTimeout(function(){var k=jQuery(G.getDomRef());var l=jQuery(this.getView().byId("ovpGlobalFilterWrapper").getDomRef());var o=k.outerHeight();i(k,l,o);l.height();l.one('transitionend',function(e){l.css("height","auto");toggleFilterBar.animationInProcess=false;});t(k,l,o);}.bind(this));}},getVisibleCustomFields:function(){var G=this.getGlobalFilter();var e=G.getAllFilterItems(true);var l,i,v=[];if(e){l=e.length;while(l--){i=e[l];if(i&&i.getVisibleInFilterBar()){v.push(i.getName());}}}var j,k,o,p=G.getFilterBarViewMetadata();var q=[];if(p){j=p.length;while(j--){o=p[j].fields;if(o){k=o.length;while(k--){if(o[k].isCustomFilterField&&v.indexOf(o[k].fieldName)>-1){q.push({name:o[k].fieldName});}}}}}return q;},_showErrorPage:function(s){if(this.getView()&&this.getView().byId&&this.getView().byId('ovpErrorPage')){var o=jQuery(this.getView().byId('ovpErrorPage').getDomRef());var e=jQuery(this.getView().byId('ovpMain').getDomRef());if(s){o.show();e.hide();return;}o.hide();e.show();}},_overrideCardModelRead:function(o,s){var e=o.read;var t=this;o.read=function(){if(s){t._processFilters();var G=t.getGlobalFilter();if(!t.aFilters){t.aFilters=[];}var j=false;var p=arguments[1];if(!p){p={};Array.prototype.push.call(arguments,p);}var E=t._getEntityTypeFromPath(o,arguments[0],p.context,false);t.sCurrentEntityType=E.entityType;if(t.sPreviousEntityType!==t.sCurrentEntityType){t.sPreviousEntityType=t.sCurrentEntityType;j=true;}if(!t.aRelevantFilters){t.aRelevantFilters=[];j=true;}if(j){t.aRelevantFilters=[];var v=false;if(t.oValueHelpMap){if(t.oValueHelpMap.indexOf(E.entityType)!=-1){v=true;}}if(E&&!v){t.aRelevantFilters=t._getEntityRelevantFilters(E,t.aFilters,o,G.getModel());}}if(t.aRelevantFilters&&t.aRelevantFilters.length>0){var k=-1;var u=p.urlParameters;if(u){for(var l=0;l<u.length;l++){if((u[l]).lastIndexOf("$filter=",0)===0){k=l;break;}}}if(k>=0){u[k]=u[k]+"%20and%20"+sap.ui.model.odata.ODataUtils.createFilterParams(t.aRelevantFilters,o.oMetadata,E).substr(8);}else{p.filters=t.aRelevantFilters;}}if(G&&G.getConsiderAnalyticalParameters()){var q=G.getAnalyticBindingPath();var I,r,w;if(q&&q.length>0){if(E.name===G.getEntityType()){r=arguments[0];I=arguments[0].indexOf('$');if(I>0){r=arguments[0].substring(0,I-1);}w=q;if(r!==w){arguments[0]=arguments[0].replace(r,w);}}else{var x=t._getParametersFromEntityPath(arguments[0]);var y=t._getParametersFromEntityPath(q);var z,H,K;if(x&&x.length>0){var L=t._getEntityTypeFromPath(o,arguments[0],p.context,true);for(var i=0;i<y.length;i++){z=t._getPropertyMapping(x,y[i].name,L.name,G.getEntityType(),o,G.getModel());if(z){H=z+"=.*?,|"+z+"=.*?\\)";K=arguments[0].match(new RegExp(H));if(K&&K.length>0){r=K[0].slice(0,-1);w=z+"="+y[i].sValue;if(r!==w){arguments[0]=arguments[0].replace(r,w);}}}}}}}}}var Q=arguments[1].success;arguments[1].success=(function(W,t){return function(){if(!t.errorHandlingObject.atLeastOneRequestSuccess){t.errorHandlingObject.atLeastOneRequestSuccess=true;t._showErrorPage(false);}if(t.filterItemInFocus!=null){t.filterItemInFocus.focus();t.filterItemInFocus=null;}if(t.nRefreshInterval!==0){if(t.oRefreshTimer!==null){clearTimeout(t.oRefreshTimer);}t.attachRefreshInterval(t.nRefreshInterval);}return W.apply(this,arguments);};})(Q,t);var V=arguments[1].error;arguments[1].error=(function(W,t){return function(){if(!t.errorHandlingObject.atLeastOneRequestSuccess){clearTimeout(t.errorHandlingObject.errorLoadingTimeout);t.errorHandlingObject.errorLoadingTimeout=setTimeout(function(){if(!t.errorHandlingObject.atLeastOneRequestSuccess){t._showErrorPage(true);}},9000);}return W.apply(this,arguments);};})(V,t);e.apply(o,arguments);};},attachRefreshInterval:function(e){this.oRefreshTimer=setTimeout(function(){for(var i in this.oCardsModels){this.oCardsModels[i].refresh(false,false);}}.bind(this),e);},_getEntityTypeFromPath:function(o,p,e,i){var s=sap.ui.model.odata.v2.ODataModel.prototype._normalizePath.apply(o,[p,e]);if(i){s=p.replace(/^\/|\/$/g,"").split("/")[0];if(s.indexOf("(")!=-1){s=s.substring(0,s.indexOf("("));}}var E=sap.ui.model.odata.ODataMetadata.prototype._getEntityTypeByPath.apply(o.oMetadata,[s]);return E;},_getPropertyMapping:function(e,t,E,s,o,j){var i,k;for(i=0;i<e.length;i++){if(e[i].name===t){k=e[i].name;return k;}if((("P_"+e[i].name)===t)||(e[i].name===("P_"+t))){k=e[i].name;return k;}}if(!E||!s||!o||!j){return;}var l=o.oMetadata._getEntityTypeByName(E);var p=j.oMetadata._getEntityTypeByName(s);if(!l||!p){return;}var q="com.sap.vocabularies.Common.v1.SemanticObject";var r="com.sap.vocabularies.Common.v1.SemanticObjectMapping";var u=o.oAnnotations.getAnnotationsData();if(!u||!u.propertyAnnotations){return;}var v=u.propertyAnnotations[l.namespace+"."+l.name];var w=j.oAnnotations.getAnnotationsData();if(!w||!w.propertyAnnotations){return;}var x=w.propertyAnnotations[p.namespace+"."+p.name];var y=x&&x[t];if(!y||!y[q]){return;}var z,G,H,I,L;for(z in v){G=v[z];if(G[q]&&G[q].String===y[q].String){H=G[r];if(!H){continue;}I=H.length;L="";while(I--){if(H[I].SemanticObjectProperty.String===t){L=H[I].LocalProperty.PropertyPath;break;}}if(L!==""){for(i=0;i<e.length;i++){if(e[i].name===L){k=e[i].name;return k;}}}}}return k;},_getParametersFromEntityPath:function(e){e=e.split("?")[0];var j=e.match(/\(.*=.*\)/);var E=[];if(!j){return E;}var p=j[0].slice(1,-1).trim().split(/\=|\,/);for(var i=0;i<p.length;i=i+2){E.push({name:p[i],sValue:p[i+1]});}return E;},_checkRelevantFiltersRecursive:function(e,o,E,t,j,k){if(!o._bMultiFilter){o.sPath=o.sPath.split('/').pop();var s=this._getPropertyMapping(e,o.sPath,E,t,j,k);if(s){o.sPath=s;return o;}}else{var l=o.aFilters;var p,q=[];if(l){for(var i=0;i<l.length;i++){p=this._checkRelevantFiltersRecursive(e,l[i],E,t,j,k);if(p){q.push(p);}}if(q.length>0){return(new F(q,o.bAnd));}}}},_getEntityRelevantFilters:function(e,i,E,o){var r=[];if(i.length>0&&e){var j=this._checkRelevantFiltersRecursive(e.property,i[0],e.name,this.getGlobalFilter().getEntityType(),E,o);if(j){r.push(j);}}return r;},_checkIsCardValid:function(s){var e=s+".Component";var o,i;jQuery.sap.require(e);var j=jQuery.sap.getObject(e);if(!j){return false;}if((j!==sap.ovp.cards.generic.Component)&&!(j.prototype instanceof sap.ovp.cards.generic.Component)){return false;}if((o=j.getMetadata())&&(i=o.getCustomizing())){if(i["sap.ui.viewReplacements"]&&i["sap.ui.viewReplacements"]["sap.ovp.cards.generic.Card"]){return false;}}if(j.prototype.createContent!=sap.ovp.cards.generic.Component.prototype.createContent){return false;}if(j.prototype.getPreprocessors!=sap.ovp.cards.generic.Component.prototype.getPreprocessors){return false;}return true;},_createCardComponent:function(v,o,e){var i="ovp:CreateCard-"+e.template+":"+e.id;jQuery.sap.measure.start(i,"Create Card","ovp");var j=v.getModel("@i18n");if(e.template&&this._checkIsCardValid(e.template)){var k={async:true,name:e.template,componentData:{model:o,modelName:e.model,i18n:j,cardId:e.id,settings:e.settings,appComponent:this.getOwnerComponent(),mainComponent:this}};var G=this.getGlobalFilter();if(G){k.componentData.globalFilter={getUiState:G.getUiState.bind(G)};}var t=v;sap.ui.component(k).then(function(l){var p=t.byId(l.getComponentData().cardId);p.setPropagateModel(true);var q=p.getComponentInstance();p.setComponent(l);if(q){setTimeout(function(){q.destroy();},0);}});}else{jQuery.sap.log.error("Could not create Card from '"+e.template+"' template. Card is not valid.");}jQuery.sap.measure.end(i);},createLoadingCard:function(e){var l=jQuery.extend(true,{},e,{template:"sap.ovp.cards.loading"});this._createCardComponent(this.getView(),undefined,l);},createCard:function(e){var v=this.getView();var o=v.getModel(e.model);Promise.all([o.getMetaModel().loaded(),this.oGlobalFilterLoadedPromise,this.oLoadedComponents[e.template]]).then(function(){this._createCardComponent(v,o,e);}.bind(this),function(r){jQuery.sap.log.error("Can't load card with id:'"+e.id+"' and type:'"+e.template+"', reason:"+r);});},_getCardId:function(e){var i=this.getView().getId()+"--";if(e.indexOf(i)!=-1){var s=e.indexOf(i)+i.length;return e.substr(s);}return e;},_initFlexibilityPersonalization:function(){this.oFlexibilityPersonalizationPromise=new Promise(function(r,e){var l=this.getLayout();var o=sap.ui.fl.FlexControllerFactory;this.oFlexController=o.createForControl(l);this.oFlexController.getComponentChanges().then(function(i){if(i.length>0){this.bDeltaChangesEnabled=true;}r();}.bind(this),function(E){r();}.bind(this));}.bind(this));},_initSmartVariantManagement:function(){if(!this.bDeltaChangesEnabled){var p=this._createPersistencyControlForSmartVariantManagement();var o=new c({type:"OVPVariant",keyName:"persistencyKey",control:p});this.oPersistencyVariantPromise=new Promise(function(r,e){this.smartVariandManagement=new S({personalizableControls:o,initialise:function(E){var k=E.getParameters().variantKeys;if(k.length){r(this.smartVariandManagement.getVariantContent(p,k[0]));}else{r(null);}}.bind(this)});this.smartVariandManagement.initialise();}.bind(this));}else{this.oPersistencyVariantPromise=Promise.resolve();}},layoutChanged:function(e){var j=e.getParameter("positionChanges");var k=[],l=[];var o,s;if(this.getLayout().getMetadata().getName()==="sap.ovp.ui.DashboardLayout"){var p=this.getLayout().dashboardLayoutUtil.dashboardLayoutModel.iColCount;if(j){for(var i=j.length-1;i>=0;i--){o=j[i];s=o.content.cardId;if(o.content.dashboardLayout.oldRow&&o.content.dashboardLayout.oldRow===o.content.dashboardLayout.row){continue;}if(l[s]){if(o.content.dashboardLayout.oldRow){l[s].content.dashboardLayout.oldRow=o.content.dashboardLayout.oldRow;}continue;}l[s]=o;}Object.keys(l).forEach(function(K){var o=l[K];if(o.content.dashboardLayout.oldRow&&o.content.dashboardLayout.oldRow===o.content.dashboardLayout.row){return;}k.push(l[K]);});k.forEach(function(o){var t=o.content.dashboardLayout;o.content.dashboardLayout={};o.content.dashboardLayout["C"+p]=t;});}}else{var q=this.getLayout().getContent();this.aOrderedCards=this._getCardArrayAsVariantFormat(q);k=j;}this.savePersonalization(k);},saveVariant:function(e){var t=this;this.smartVariandManagement.getVariantsInfo(function(v){var p=null;if(v&&v.length>0){p=v[0].key;}var o=p!==null;var i={name:"Personalisation",global:false,overwrite:o,key:p,def:true};t.smartVariandManagement.fireSave(i);});},savePersonalization:function(o){var l=this.getLayout();if(l){if(o){if(!Array.isArray(o)){this.oFlexController.createAndApplyChange(o,l);}else{o.forEach(function(i){this.oFlexController.createAndApplyChange(i,l);}.bind(this));}this.oFlexController.saveAll();return;}var e,s;if(l.getMetadata().getName()==="sap.ovp.ui.DashboardLayout"){e={cards:l.getLayoutDataJSON()};s="manageCardsForDashboardLayout";}else{e=this._getCardArrayAsVariantFormat(l.getContent());s="manageCardsForEasyScanLayout";}this.oFlexController.createAndApplyChange({changeType:s,content:e,isUserDependent:true},l);this.oFlexController.saveAll();}},getLayout:function(){return this.getView()?this.getView().byId("ovpLayout"):null;},_createPersistencyControlForSmartVariantManagement:function(){var t=this;sap.ui.core.Control.extend("sap.ovp.app.PersistencyControl",{metadata:{properties:{persistencyKey:{type:"string",group:"Misc",defaultValue:null}}}});var p=new sap.ovp.app.PersistencyControl({persistencyKey:"ovpVariant"});p.fetchVariant=function(){if(t.isInitialLoading){t.isInitialLoading=false;return{};}var l=this.getLayout();if(!l){jQuery.sap.log.error("Could not save persistency variant - 'ovpLayout' does not exists");return;}if(this.getLayout().getMetadata().getName()==="sap.ovp.ui.DashboardLayout"){var v=this.getLayout().getLayoutDataJSON();return{cards:v};}else{var L=l.getContent();var e=this._getCardArrayAsVariantFormat(L);this.oOrderedCards=e;return{cards:e};}}.bind(this);return p;},_initShowHideCardsButton:function(){var r=sap.ushell.Container.getRenderer("fiori2"),e={controlType:"sap.ushell.ui.launchpad.ActionItem",bCurrentState:false,oControlProperties:{icon:"sap-icon://dimension",text:this._getLibraryResourceBundle().getText("hideCardsBtn_title"),tooltip:this._getLibraryResourceBundle().getText("hideCardsBtn_tooltip"),press:this._onCardMenuButtonPress.bind(this)},bIsVisible:true,aStates:["app"]};r.addUserAction(e);},_onCardMenuButtonPress:function(){var o,l=this.getLayout().getMetadata().getName();this.visibilityChanges=[];function e(w,x){for(var i=0;i<w.length;i++){if(w[i].id==x){return i;}}return-1;}function j(w,x,y){var z=-1;for(var i=0;i<x.length;i++){if(w[i].id==x[i].id){z=i;}else{z=e(w,x[i].id);}var E=this.getView().byId(x[i].id);var G=E.getComponentInstance();if(y){if(G){G.destroy();}}if(x[i].visibility!=w[z].visibility||y){if(x[i].visibility===true){var H=this._getCardFromManifest(x[i].id);if(H){this.createLoadingCard(H);H.settings.baseUrl=this._getBaseUrl();this._clearStoredEntities();this._initCardModel(H.model);this._loadCardComponent(H.template);this._createModelViewMap(H);if(H.settings.tabs){var I=0;if(this.aOrderedCards[i].selectedKey){I=this.aOrderedCards[i].selectedKey-1;}this.initializeTabbedCard(H,I);}this.createCard(H);}}else{if(G){G.destroy();}}}}}function k(i){var w=this._getCardFromManifest(i);if(w){var x=w.settings;if(x.title){return x.title;}else if(x.category){return(x.category);}else if(x.subTitle){return x.subTitle;}return i;}else{console.log("Card id "+i+" is not available in the manifest");return"";}}var p=new f({cells:[new T({text:{path:"id",formatter:k.bind(this)}}),new g({state:"{visibility}",customTextOff:" ",customTextOn:" ",change:function(i){var w=i.oSource.getParent();w.toggleStyleClass('sapOVPHideCardsTableItem');w.getCells()[0].toggleStyleClass('sapOVPHideCardsDisabledCell');var x=i.getSource().getBindingContext().getObject();var I=this.visibilityChanges.findIndex(function(y,z,E){return y.content.cardId===x.id;});if(I>-1){this.visibilityChanges.splice(I,1);}else{this.visibilityChanges.push({changeType:"visibility",content:{cardId:x.id,visibility:i.getParameter("state")},isUserDependent:true});}}.bind(this),tooltip:this._getLibraryResourceBundle().getText("hideCards_switchTooltip")})]});var q=new h("sapOVPHideCardsTable",{backgroundDesign:sap.m.BackgroundDesign.Transparent,showSeparators:sap.m.ListSeparators.Inner,columns:[new m({vAlign:"Middle"}),new m({hAlign:sap.ui.core.TextAlign.Right,vAlign:"Middle",width:"4.94rem"})]});q.addStyleClass('sapOVPHideCardsTable');q.bindItems({path:"/cards",template:p});var r=q.onAfterRendering;q.onAfterRendering=function(w){r.apply(q,arguments);var x=w.srcControl.mAggregations.items;if(x){for(var i=0;i<x.length;i++){if(!x[i].getCells()[1].getState()){x[i].addStyleClass('sapOVPHideCardsTableItem');x[i].getCells()[0].addStyleClass('sapOVPHideCardsDisabledCell');}}}setTimeout(function(){jQuery('.sapMListTblRow').first().focus();},200);};var s=new n("manageCardsokBtn",{text:this._getLibraryResourceBundle().getText("okBtn"),press:function(){var i=this.oDialog.getModel().getProperty('/cards');j.apply(this,[this.aOrderedCards,i,false]);this.aOrderedCards=i;this._updateDashboardLayoutCards(this.aOrderedCards);this._updateLayoutWithOrderedCards();this.savePersonalization(this.visibilityChanges);this.oDialog.close();}.bind(this)});var t=new n("manageCardsCancelBtn",{text:this._getLibraryResourceBundle().getText("cancelBtn"),press:function(){this.oDialog.close();}.bind(this)});var u=new n("manageCardsResetBtn",{text:this._getLibraryResourceBundle().getText("resetBtn"),enabled:((l==="sap.ovp.ui.DashboardLayout")?true:this.isValidForReset()),press:function(){sap.m.MessageBox.show(this._getLibraryResourceBundle().getText("reset_cards_confirmation_msg"),{id:"resetCardsConfirmation",icon:sap.m.MessageBox.Icon.QUESTION,title:this._getLibraryResourceBundle().getText("reset_cards_confirmation_title"),actions:[sap.m.MessageBox.Action.OK,sap.m.MessageBox.Action.CANCEL],onClose:function(i){if(i===sap.m.MessageBox.Action.OK){j.apply(this,[this.aOrderedCards,this.aManifestOrderedCards,(l==="sap.ovp.ui.DashboardLayout")?true:false]);this.aOrderedCards=this.aManifestOrderedCards;this._resetDashboardLayout();this._updateDashboardLayoutCards(this.aOrderedCards);this._updateLayoutWithOrderedCards();this.oFlexController.discardChangesForId(this.getLayout().getId(),true);this.oDialog.close();}}.bind(this)});}.bind(this)});this.oDialog=new D({title:this._getLibraryResourceBundle().getText("hideCardsBtn_title"),contentWidth:"29.6rem",contentHeight:"50%",stretch:sap.ui.Device.system.phone,content:q,buttons:[s,t,u],afterClose:function(){this.visibilityChanges=[];this.oDialog.destroy();}.bind(this)}).addStyleClass("sapOVPCardsVisibilityDialog");var v;if(l==="sap.ovp.ui.DashboardLayout"){v=jQuery.extend(true,[],this._getCardArrayAsVariantFormatDashboard());}else{v=jQuery.extend(true,[],this.aOrderedCards);}o=new J({cards:v});this.oDialog.setModel(o);this.oDialog.open();},isValidForReset:function(){for(var i=0;i<this.aManifestOrderedCards.length;i++){if(this.aManifestOrderedCards[i].id!==this.aOrderedCards[i].id||this.aManifestOrderedCards[i].visibility!==this.aOrderedCards[i].visibility){return true;}}return false;},isDragAndDropEnabled:function(){return!sap.ui.Device.system.phone;},getGlobalFilter:function(){if(!this.oGlobalFilter){this.oGlobalFilter=this.getView().byId("ovpGlobalFilter");}return this.oGlobalFilter;},getUIModel:function(){if(!this.oUIModel){var o=this.getOwnerComponent();this.oUIModel=o&&o.getModel("ui");}return this.oUIModel;},_parseNavigationVariant:function(){this.oParseNavigationPromise=this.oNavigationHandler.parseNavigation();},_setNavigationVariantToGlobalFilter:function(o,u,s){var G=this.getGlobalFilter();if(!G){return;}switch(s){case"iAppState":if(o.selectionVariant){var e,j,k,l=false;var p,q,r,t;var v,w,x;G.clearVariantSelection();e=JSON.parse(o.selectionVariant);G.setCurrentVariantId(e.SelectionVariantID);w=G.getUiState({allFilters:false});q=w&&JSON.stringify(w.getSelectionVariant());t=G.getFilterData()._CUSTOM;t=((typeof t=='undefined')?{}:t);v=new U({selectionVariant:o.oSelectionVariant.toJSONObject()});G.setUiState(v,{replace:true,strictMode:false});j=new d(o.selectionVariant);k=j.getParameterNames().concat(j.getSelectOptionsPropertyNames());for(var i=0;i<k.length;i++){G.addFieldToAdvancedArea(k[i]);}x=G.getUiState({allFilters:false});p=x&&JSON.stringify(x.getSelectionVariant());if(q!==p){l=true;}if(o.customData&&Object.keys(o.customData).length>0){var r=o.customData;this.restoreCustomAppStateDataExtension(r);if(JSON.stringify(t)!==JSON.stringify(r)){l=true;}}G.getSmartVariant().currentVariantSetModified(l);G._updateToolbarText();}break;case"xAppState":case"URLParams":var v,y=[];var z=new d(o.oSelectionVariant.toJSONObject());var E=new d(o.oDefaultedSelectionVariant.toJSONObject());if(!o.bNavSelVarHasDefaultsOnly&&!z.isEmpty()){v=new U({selectionVariant:z.toJSONObject()});G.clearVariantSelection();G.clear();G.setUiState(v,{replace:true,strictMode:false});y=y.concat(z.getParameterNames().concat(z.getSelectOptionsPropertyNames()));}if(o.bNavSelVarHasDefaultsOnly&&!E.isEmpty()&&G.getCurrentVariantId()===""){v=new U({selectionVariant:E.toJSONObject()});G.setUiState(v,{replace:false,strictMode:false});y=y.concat(E.getParameterNames().concat(E.getSelectOptionsPropertyNames()));}var L;if(y&&y.length>0){L=y.length;while(L--){G.addFieldToAdvancedArea(y[L]);}}if(G.getCurrentVariantId()!==""){this._setDisplayCurrency(E);}break;}},_setDisplayCurrency:function(o){var G=this.getGlobalFilter();if(!G){return;}var l,e;var p=G.getAnalyticalParameters();if(p&&p.length>0){l=p.length;while(l--){if((p[l].name==="P_DisplayCurrency")||(p[l].name==="DisplayCurrency")){e=p[l];break;}}}if(!e){return;}var i=G.getFilters([e.fieldName]);var s=i&&i[0]&&i[0].oValue1;if(s&&s!==" "){return;}var j,k;if(e.name.indexOf("P_")===0){k=e.name;j=e.name.substr(2);}else{k="P_"+e.name;j=e.name;}if(o&&!o.isEmpty()){var q;s=o.getParameter(j);if(!s||s===" "){s=o.getParameter(k);}if(!s||s===" "){q=o.getSelectOption(j);s=q&&q[0]&&q[0].Low;}if(!s||s===" "){q=o.getSelectOption(k);s=q&&q[0]&&q[0].Low;}}if(!s||s===" "){s=e.defaultPropertyValue;}if(!s||s===" "){return;}var r=new d();r.addParameter(e.name,s);var u=new U({selectionVariant:r.toJSONObject()});G.setUiState(u,{replace:false,strictMode:false});},_enhanceVariant:function(v,o,s){var p=v.getParameter(o);var e=v.getSelectOption(o);if(p){v.renameParameter(o,s);}else if(e){var V=e[0]&&e[0].Low;if(V&&V!==""){V+="";v.addParameter(s,V);v.removeSelectOption(o);}}return v;},onBeforeSFBVariantSave:function(){var o={};this.getCustomAppStateDataExtension(o);this.getGlobalFilter().setFilterData({_CUSTOM:o});},onAfterSFBVariantLoad:function(){var o=this.getGlobalFilter().getFilterData();if(o._CUSTOM&&Object.keys(o._CUSTOM).length>0){this.restoreCustomAppStateDataExtension(o._CUSTOM);}},onAssignedFiltersChanged:function(e){if(e.getSource()&&this.getView().byId("ovpFilterText")){this.getView().byId("ovpFilterText").setText(e.getSource().retrieveFiltersWithValuesAsText());}},_getCurrentAppState:function(){var G=this.getGlobalFilter();var u=G.getUiState({allFilters:false});var s=u&&u.getSelectionVariant();if(G.getSmartVariant().currentVariantGetModified()){s.SelectionVariantID="";}var e=s&&JSON.stringify(s);var o=new d(e);var i={};this.getCustomAppStateDataExtension(i);return{selectionVariant:o.toJSONString(),customData:i};},_storeCurrentAppStateAndAdjustURL:function(e){if(e&&!e.oSource._bDirtyViaDialog){return;}if(!this.bGlobalFilterLoaded){return;}if(this.oAppStatePromise){this.rejectPreviousPromise&&this.rejectPreviousPromise("skip");}this.oAppStatePromise=new Promise(function(j,k){this.rejectPreviousPromise=k;var o=this._getCurrentAppState();var l=this.oNavigationHandler.storeInnerAppStateWithImmediateReturn(o);l.promise.then(function(s){j(s);},function(E){k(E.getErrorCode());});}.bind(this));var i=function(s){this.oAppStatePromise=null;if(s&&s.length>0){this.oNavigationHandler.replaceHash(s);return;}throw"AppState key is empty";};var r=function(E){this.oAppStatePromise=null;if(E==="skip"){throw E;}throw("Something went wrong while storing AppState - "+E);};this.oAppStatePromise.then(i.bind(this),r.bind(this)).catch(function(E){if(E==="skip"){return;}jQuery.sap.log.error(E);});}});});
